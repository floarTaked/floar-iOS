//
//  InfoDetailDataManager.m
//  WeLinked3
//
//  Created by Floar on 14-3-9.
//  Copyright (c) 2014å¹´ WeLinked. All rights reserved.
//

#import "InfoDetailDataManager.h"
#import "NetworkEngine.h"
#import "Article.h"

@implementation InfoDetailDataManager

-(id)init
{
    self = [super init];
    
    if (self)
    {
        self.infoDetailArray = [[NSMutableArray alloc] init];
    }
    return self;
}

-(void)dealloc
{
    self.infoDetailArray = nil;
}

-(void)setInfoDetailSubscribeItem:(NSString *)infoDetailSubscribeItem
{
    _infoDetailSubscribeItem = infoDetailSubscribeItem;
    [self loadinfoDetailDataFromDB];
    
}

-(void)loadinfoDetailDataWithSubscribeItem:(NSString *)subscribeItem
{
    [[NetworkEngine sharedInstance] getArticleList:subscribeItem withAritcle:nil block:^(int event, id object)
    {
         if (1 == event)
         {
             [self.infoDetailArray removeAllObjects];
             for (NSDictionary *dic in object)
             {
                 Article *article = [[Article alloc] init];
                 [article setValuesForKeysWithDictionary:dic];
                 article.columnId = subscribeItem;
                 [self.infoDetailArray addObject:article];
                 [article synchronize:nil];
             }
             
             if ([_delegate respondsToSelector:@selector(infoDetailDataManagerGetDataSuccess)])
             {
                 [_delegate infoDetailDataManagerGetDataSuccess];
             }
         }
         else
         {
             [_delegate infoDetailDataManagerGetDataFailed];
         }
     }];
}

-(void)loadMoreinfoDetailDataWithSubscribeItem:(NSString *)subscribeItem andLastArticleId:(NSString *)lastArticleId
{
    [[NetworkEngine sharedInstance] getArticleList:subscribeItem withAritcle:lastArticleId block:^(int event, id object)
     {
         if (1 == event)
         {
             for (NSDictionary *dic in object)
             {
                 Article *article = [[Article alloc] init];
                 [article setValuesForKeysWithDictionary:dic];
                 article.columnId = subscribeItem;
                 [self.infoDetailArray addObject:article];
                 [article synchronize:nil];
             }
             
             if ([_delegate respondsToSelector:@selector(infoDetailDataManagerGetDataSuccess)])
             {
                 [_delegate infoDetailDataManagerGetDataSuccess];
             }
         }
         else
         {
             [_delegate infoDetailDataManagerGetDataFailed];
             NSLog(@"articleList error");
         }
     }];
}

-(void)loadinfoDetailDataFromDB
{
    NSArray *array = [[UserDataBaseManager sharedInstance] queryWithClass:[Article class] tableName:nil condition:[NSString stringWithFormat:@"where columnId = '%@'",self.infoDetailSubscribeItem]];
    [self.infoDetailArray addObjectsFromArray:array];
}

@end
